

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Configuration &mdash; uap 0.1.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="uap 0.1.1 documentation" href="index.html"/>
        <link rel="next" title="Configuration of uap" href="documentation.html"/>
        <link rel="prev" title="Installation" href="installation.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> uap</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#downloading-the-software">Downloading the software</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#making-uap-globally-available">Making <strong>uap</strong> Globally Available</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Configuration of <strong>uap</strong></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sections-of-config-yaml">Sections of config.yaml</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-to-create-your-first-uap-analysis">How-To Create Your First <strong>uap</strong> Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-sequencing-analysis-steps">General sequencing analysis steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rnaseq-analysis">RNAseq analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#chipseq-analysis">ChIPseq analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prepare-ucsc-genome-browser-tracks">Prepare UCSC genome browser tracks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#interacting-with-a-pipeline">Interacting with a pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="#post-mortem-pipeline-analysis">Post-mortem pipeline analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="#extending-rnaseq-pipeline">Extending rnaseq-pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#best-practices">Best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#to-do-list">To-do list</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Configuration of <strong>uap</strong></a><ul>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#sections-of-config-yaml">Sections of config.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#general-sequencing-analysis-steps">General sequencing analysis steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#rnaseq-analysis">RNAseq analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#chipseq-analysis">ChIPseq analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#prepare-ucsc-genome-browser-tracks">Prepare UCSC genome browser tracks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html#interacting-with-a-pipeline">Interacting with a pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html#post-mortem-pipeline-analysis">Post-mortem pipeline analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html#extending-rnaseq-pipeline">Extending rnaseq-pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="documentation.html#best-practices">Best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html#to-do-list">To-do list</a></li>
<li class="toctree-l1"><a class="reference internal" href="steps.html">Available steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="steps.html#source-steps">Source steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="steps.html#processing-steps">Processing steps</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">uap</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Configuration</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/configuration.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="configuration-of-uap">
<h1>Configuration of <strong>uap</strong><a class="headerlink" href="#configuration-of-uap" title="Permalink to this headline">¶</a></h1>
<p><strong>uap</strong> is made to control the execution of data analyses which are defined
in <a class="reference external" href="http://www.yaml.org/">YAML</a> files.
Each file describes a complete analysis.
Further on these files are called analysis file(s).</p>
<p>The analysis files consist of four sections (let&#8217;s just call them sections,
although technically, they are keys):</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">destination_path</span></code> &#8211; points to the directory where the result files,
annotations and temporary files are written to</li>
<li><code class="docutils literal"><span class="pre">email</span></code> &#8211; when submitting jobs on a cluster, messages will be sent to
this email address by the cluster scheduler (<a class="reference external" href="mailto:nobody&#37;&#52;&#48;example&#46;com">nobody<span>&#64;</span>example<span>&#46;</span>com</a> by default)</li>
<li><code class="docutils literal"><span class="pre">constants</span></code> &#8211; defines constants for later use (define repeatedly used
values as constants to increase readability of the following sections)</li>
<li><code class="docutils literal"><span class="pre">tools</span></code> &#8211; defines all tools used in the pipeline and how to determine
their versions (for later reference)</li>
<li><code class="docutils literal"><span class="pre">steps</span></code> &#8211; defines the processing step and their order</li>
</ul>
<p>If you want to know more about the notation that is used in this file, have a
closer look at the <a class="reference external" href="http://www.yaml.org/">YAML definition</a>.</p>
<div class="section" id="sections-of-config-yaml">
<h2>Sections of config.yaml<a class="headerlink" href="#sections-of-config-yaml" title="Permalink to this headline">¶</a></h2>
<div class="section" id="destination-path">
<h3>destination_path<a class="headerlink" href="#destination-path" title="Permalink to this headline">¶</a></h3>
<p>The value of <code class="docutils literal"><span class="pre">destination_path</span></code> is the directory where <strong>uap</strong> is going
to store the created files. It is possible to use a different directory for
volatile files (see ).</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">destination_path</span><span class="p-Indicator">:</span> <span class="s">&quot;/path/to/dir&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="email">
<h3>email<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h3>
<p>The value of <code class="docutils literal"><span class="pre">email</span></code> is needed if the pipeline is executed on a cluster,
which can use it to inform the person who started <strong>uap</strong> about status
changes of submitted jobs.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&quot;your.name@mail.de&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="tools">
<h3>tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">tools</span></code> block describes all programs needed during the execution of the
<em>uap*</em>.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tools</span><span class="p-Indicator">:</span>
    <span class="c1"># you don&#39;t have to specify a path if the tool can be found in $PATH</span>
    <span class="l-Scalar-Plain">cat</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cat</span>
        <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;--version&quot;</span>
    <span class="c1"># you have to specify a path if the tool can not be found in $PATH</span>
    <span class="l-Scalar-Plain">some-tool</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/some-tool</span>
        <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;--version&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="steps">
<h3>steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">steps</span></code> block is the core of the analysis file, because it defines the
order in which the different steps of the analysis are executed.
Each step must have a unique name.
Therefore you should give each step a descriptive name followed by
a blank and the step type enclosed in parentheses.</p>
<p>There are two different types of steps:</p>
<ol class="arabic simple">
<li><strong>source steps</strong> are used to enter data into the analysis, meaning they have no
predecessor step they depend on.</li>
<li><strong>processing steps</strong> depend upon one or more predecessor steps and create some
output that can be used by successor steps.</li>
</ol>
<p>All available steps are described in detail in the steps documentation:
<a class="reference internal" href="steps.html"><em>Available steps</em></a>.</p>
<p>Example configurations for various source steps are shown below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># sources steps</span>
<span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
    <span class="c1"># fastq_source provides a number of fastq.gz files as pipeline input</span>
    <span class="l-Scalar-Plain">casava_output (fastq_source)</span><span class="p-Indicator">:</span>
        <span class="c1"># a glob pattern</span>
        <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/kaempf/Projects/RNAseq_Jurkats+BaP/data/</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">(Sample_COPD_\d+)_R[12]-head.fastq.gz</span>
        <span class="l-Scalar-Plain">indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">indices.csv</span>
        <span class="l-Scalar-Plain">paired_end</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>

    <span class="c1"># run_folder_sources</span>
    <span class="l-Scalar-Plain">fc1 (run_folder_source)</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/data/bioinf/projects/data/Jurkats_BaP_Transcriptome/130108_SN928_0083_AD11VNACXX_Keep/</span>
        <span class="l-Scalar-Plain">paired_end</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
    <span class="l-Scalar-Plain">fc2 (run_folder_source)</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/data/bioinf/projects/data/Jurkats_BaP_Transcriptome/130108_SN928_0084_BC0UT2ACXX_Keep/</span>
        <span class="l-Scalar-Plain">paired_end</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>

    <span class="c1"># raw_file_source can provide any filesystem file as pipeline input</span>
    <span class="l-Scalar-Plain">mapped_reads (raw_file_source)</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">data/H3K4me3_GCCAAT_L001_001.dup_rm.sam.gz</span>
        <span class="l-Scalar-Plain">sha1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">835779504aa63f80c9e1008f93f554269d0ec506</span>

    <span class="c1"># raw_url_source can provide any downloadable file as pipeline input</span>
    <span class="l-Scalar-Plain">gencode (raw_url_source)</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ftp://ftp.sanger.ac.uk/pub/gencode/release_15/gencode.v15.annotation.gtf.gz</span>
        <span class="l-Scalar-Plain">sha1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9b272fde8bca544e6cd8621ddeec55aa09cf7a05</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-create-your-first-uap-analysis">
<h1>How-To Create Your First <strong>uap</strong> Analysis<a class="headerlink" href="#how-to-create-your-first-uap-analysis" title="Permalink to this headline">¶</a></h1>
<p>Next, edit <code class="docutils literal"><span class="pre">config.sample.yaml</span></code> and save it as <code class="docutils literal"><span class="pre">config.yaml</span></code>.
Although writing the configuration may seem a bit complicated, the trouble
pays off later because further interaction with the pipeline is quite simple.
Here is a sample configuration:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># This is the rnaseq-pipeline configuration file.</span>

<span class="l-Scalar-Plain">destination_path</span><span class="p-Indicator">:</span> <span class="s">&quot;/home/michael/test-pipeline/out&quot;</span>

<span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">fastq_source</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/michael/test-pipeline/fastq/*.fastq.gz</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">(Sample_COPD_\d+)_R[12]-head.fastq.gz</span>
        <span class="l-Scalar-Plain">indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">copd-barcodes.csv</span>
        <span class="l-Scalar-Plain">paired_end</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>

    <span class="l-Scalar-Plain">cutadapt</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">_depends</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fastq_source</span>
        <span class="l-Scalar-Plain">adapter-R1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC((INDEX))ATCTCGTATGCCGTCTTCTGCTTG</span>
        <span class="l-Scalar-Plain">adapter-R2</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTAGATCTCGGTGGTCGCCGTATCATT</span>

<span class="l-Scalar-Plain">tools</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cutadapt</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/michael/Desktop/rnaseq-pipeline/tools/cutadapt-1.2.1/bin/cutadapt</span>
        <span class="l-Scalar-Plain">get_version</span><span class="p-Indicator">:</span> <span class="s">&#39;--version&#39;</span>
    <span class="l-Scalar-Plain">pigz</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pigz</span>
        <span class="l-Scalar-Plain">get_version</span><span class="p-Indicator">:</span> <span class="s">&#39;--version&#39;</span>
    <span class="l-Scalar-Plain">head</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">head</span>
        <span class="l-Scalar-Plain">get_version</span><span class="p-Indicator">:</span> <span class="s">&#39;--version&#39;</span>
    <span class="l-Scalar-Plain">cat4m</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./tools/cat4m</span>
</pre></div>
</div>
<p>There is currently no step implemented to execute Illuminas CASAVA pipeline, which
converts BCL files to FASTQ files. Therefore all example configurations
begin with a source step that relies on the availability of fastq.gz files.</p>
<div class="section" id="general-sequencing-analysis-steps">
<h2>General sequencing analysis steps<a class="headerlink" href="#general-sequencing-analysis-steps" title="Permalink to this headline">¶</a></h2>
<p>Every analysis of high-throughput sequencing results starts with some basic
steps. Irrespective of sequencing RNA or DNA, given a reference genome
exists.</p>
<ol class="arabic simple">
<li>Get the sequencing reads as input (most likely fastq.gz)</li>
<li>Remove adapter sequences from your sequencing reads</li>
<li>Align the sequencing reads onto the refernce genome</li>
</ol>
<p>After these steps are finished a lot of different analysis could be applied on
the data. Furtheron example configurations for often used analyses are shown.
The enumeration of steps show continues as if the basic steps were already
performed.</p>
</div>
<div class="section" id="rnaseq-analysis">
<h2>RNAseq analysis<a class="headerlink" href="#rnaseq-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="differential-expression">
<h3>Differential expression<a class="headerlink" href="#differential-expression" title="Permalink to this headline">¶</a></h3>
<p>RNAseq analysis often aims at the discovery of differentially expressed
(known) transcripts. Therefore mappped reads for at least two different samples
have to be available.</p>
<ol class="arabic simple" start="4">
<li>Get annotation set (for e.g. genes, transcripts, ...)</li>
<li>Count the number of reads overlapping the annotation</li>
<li>Perform statistical analysis, based on counts</li>
</ol>
</div>
<div class="section" id="assemble-novel-transcripts">
<h3>Assemble novel transcripts<a class="headerlink" href="#assemble-novel-transcripts" title="Permalink to this headline">¶</a></h3>
<p>As the publicly available annotations, e.g. from GENCODE, are probably not
complete, the assembly of novel transcripts from RNAseq data is another task one
would perform to invetsigate the transcriptome.</p>
</div>
</div>
<div class="section" id="chipseq-analysis">
<h2>ChIPseq analysis<a class="headerlink" href="#chipseq-analysis" title="Permalink to this headline">¶</a></h2>
<p>ChIPseq analysis aims at the discovery of genomic loci at which protein(s) of
interest were bound. The experiment is an enrichment procedure using specific
antibodies. The enrichment detection is normally performed by so called peak
calling programs.</p>
<ol class="arabic simple" start="4">
<li>Get negative control</li>
<li>Peak calling</li>
</ol>
</div>
<div class="section" id="prepare-ucsc-genome-browser-tracks">
<h2>Prepare UCSC genome browser tracks<a class="headerlink" href="#prepare-ucsc-genome-browser-tracks" title="Permalink to this headline">¶</a></h2>
<p>The conversion of sequencing data into an format that can be displayed by the
UCSC genome browser is needed in almost all sequencing projects.</p>
</div>
</div>
<div class="section" id="interacting-with-a-pipeline">
<h1>Interacting with a pipeline<a class="headerlink" href="#interacting-with-a-pipeline" title="Permalink to this headline">¶</a></h1>
<p>Once the project is set up, there are several scripts which can be used to
execute and monitor the pipeline.
All scripts have a couple of properties in common:</p>
<ul class="simple">
<li>On startup, the configuration is read, tools are checked, input files are
collected, and all tasks are calculated.
If any of these steps fails, the script will print an error message with
a backtrace and it will crash.
This may seem a bit harsh, but after all, it&#8217;s better to fail early than
to fail late if failing is unavoidable.</li>
<li>For convenience, a symbolic link called <code class="docutils literal"><span class="pre">out</span></code> will be placed in the
pipeline&#8217;s directory which points to the output directory defined in the
configuration file.
If <code class="docutils literal"><span class="pre">out</span></code> already exists, it is left untouched.</li>
</ul>
<p>There are a couple of global command line parameters which are valid for all
scripts (well, actually, it&#8217;s only one):</p>
<ul>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">--even-if-dirty</span></code>:</dt>
<dd><p class="first last">Before doing anything else, the pipeline checks whether its source code
has been modified in any way via Git.
If yes, processing is stopped immediately unless this flag is specified.
If you specify the flag, the fact that the repository was dirty will be
recorded in all annotations which are produces <em>including</em> a full Git diff.</p>
</dd>
</dl>
</li>
</ul>
<p>In the following, the scripts are described in detail.</p>
<p>The status script lists all tasks resulting from the configured steps and
input samples.
At any time, each task is in one of the following states:</p>
<ul class="simple">
<li><strong>waiting</strong> &#8211; the task is waiting for input files to appear, or its input
files are not up-to-date regarding their respective dependencies</li>
<li><strong>ready</strong> &#8211; all input files are present and up-to-date regarding their
upstream input files (and so on, recursively), the task is ready and can
be started</li>
<li><strong>queued</strong> &#8211; the task is currently queued and will be started &#8220;soon&#8221;
(if you use a computing cluster)</li>
<li><strong>executing</strong> &#8211; the task is currently running on this or another machine</li>
<li><strong>finished</strong> &#8211; all output files are in place and up-to-date</li>
</ul>
<p>Here is an example output:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py
Waiting tasks
-------------
[w] cufflinks/Sample_COPD_2023

Ready tasks
-----------
[r] tophat2/Sample_COPD_2023

Finished tasks
--------------
[f] cutadapt/Sample_COPD_2023-R1
[f] cutadapt/Sample_COPD_2023-R2
[f] fix_cutadapt/Sample_COPD_2023

tasks: 5 total, 1 waiting, 1 ready, 3 finished
</pre></div>
</div>
<p>To get a more concise summary, specify <code class="docutils literal"><span class="pre">--summarize</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py --summarize
Waiting tasks
-------------
[w]   1 cufflinks

Ready tasks
-----------
[r]   1 tophat2

Finished tasks
--------------
[f]   2 cutadapt
[f]   1 fix_cutadapt

tasks: 5 total, 1 waiting, 1 ready, 3 finished
</pre></div>
</div>
<p>...or print a fancy ASCII art graph with <code class="docutils literal"><span class="pre">--graph</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py --graph
samples (1 finished)
└─cutadapt (2 finished)
  └─fix_cutadapt (1 finished)
    └─tophat2 (1 ready)
      └─cufflinks (1 waiting)
</pre></div>
</div>
<p>Detailed information about a specific task can be obtained by specifying the
task ID on the command line:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py cutadapt/Sample_COPD_2023-R1
info:
  adapter: AGATCGGAAGAGCACACGTCTGAACTCCAGTCACACAGTGATCTCGTATGCCGTCTTCTGCTTG
read_number: R1
output_files:
  log:
    /home/michael/Desktop/rnaseq-pipeline/out/cutadapt-7708/Sample_COPD_2023-cutadapt-R1-log.txt:
    - /home/michael/Desktop/rnaseq-pipeline/copd-small/Sample_COPD_2023_R1.fastq.gz
  reads:
    /home/michael/Desktop/rnaseq-pipeline/out/cutadapt-7708/Sample_COPD_2023-cutadapt-R1.fastq.gz:
    - /home/michael/Desktop/rnaseq-pipeline/copd-small/Sample_COPD_2023_R1.fastq.gz
state: FINISHED
</pre></div>
</div>
<p>This data structure is called the &#8220;run info&#8221; of a certain run and it
represents a kind of plan which includes information about which output
files will be generated and which input files they depend on &#8211; this is
stored in <code class="docutils literal"><span class="pre">output_files</span></code>.
Furthermore, necessary information for actually executing the task are
recorded in <code class="docutils literal"><span class="pre">info</span></code>.
In this case, the final adapter has been determined by replacing <code class="docutils literal"><span class="pre">((INDEX))</span></code>
in the configuration file&#8217;s <code class="docutils literal"><span class="pre">adapter-R1</span></code> with the actual barcode index of
the sample.</p>
<p>Because source steps produce no runs and therefore no tasks, they don&#8217;t
appear in the list produced by <code class="docutils literal"><span class="pre">status.py</span></code>.
To see their task IDs, specify <code class="docutils literal"><span class="pre">--sources</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py --sources
samples/Sample_COPD_2023
</pre></div>
</div>
<p>You can then specify the ID of a source task like the ID of any other task
to see its details:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./status.py samples/Sample_COPD_2023
info:
  index: ACAGTG
  paired_end: true
  read_number:
    Sample_COPD_2023_R1.fastq.gz: R1
    Sample_COPD_2023_R2.fastq.gz: R2
output_files:
  reads:
    /home/michael/Desktop/rnaseq-pipeline/copd-small/Sample_COPD_2023_R1.fastq.gz: []
    /home/michael/Desktop/rnaseq-pipeline/copd-small/Sample_COPD_2023_R2.fastq.gz: []
  state: FINISHED
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">run-locally.py</span></code> script runs all non-finished tasks (or a subset)
sequentially on the local machine.
Feel free to cancel this script at any time, it won&#8217;t put your project in a
confused state.
However, if the <code class="docutils literal"><span class="pre">run-locally.py</span></code> script receives a SIGKILL signal, the
currently executing job will continue to run and the corresponding task
will be reported as <code class="docutils literal"><span class="pre">executing</span></code> by <code class="docutils literal"><span class="pre">status.py</span></code> for five more minutes
(SIGTERM should be fine and exit gracefully but <em>doesn&#8217;t just yet</em>).
After that time, you will be warned that a job is marked as being currently
run but no activity has been seen for a while, along with further
instructions about what to do in such a case (don&#8217;t worry, it shouldn&#8217;t
happen by accident).</p>
<p>To execute one or more certain tasks, specify the task IDs on the command
line.
To execute all tasks of a certain step, specify the step name on the command
line.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Why is it safe to cancel the pipeline?
The pipeline is written in a way which expects processes to fail or
cluster jobs to disappear without notice.
This problem is mitigated by a design which relies on file presence and
file timestamps to determine whether a task is finished or not.
Output files are automatically written to temporary locations and later
moved to their real target directory, and it is not until the last file
rename operation has finished that a task is regarded as finished.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">submit-to-cluster.py</span></code> script determines which tasks still have to be
carried out and submits the jobs to a GridEngine cluster by calling <code class="docutils literal"><span class="pre">qsub</span></code>.
Dependencies are passed to <code class="docutils literal"><span class="pre">qsub</span></code> via the <code class="docutils literal"><span class="pre">-hold_jid</span></code> option, which means
that jobs that depend on other jobs won&#8217;t get scheduled until their
dependencies have been satisfied.
The file <code class="docutils literal"><span class="pre">qsub-template.sh</span></code> is used to submit jobs, with <code class="docutils literal"><span class="pre">#{</span> <span class="pre">}</span></code> fields
being substituted with appropriate values.</p>
<p>The file <code class="docutils literal"><span class="pre">quotas.yaml</span></code> can be used to define different quotas for different
systems:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="s">&quot;frontend[12]&quot;</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
    <span class="l-Scalar-Plain">cutadapt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
</pre></div>
</div>
<p>In the example above, a default quota of 5 is defined for hosts with a
hostname of <code class="docutils literal"><span class="pre">frontend1</span></code> or <code class="docutils literal"><span class="pre">frontend2</span></code> (the name is a regular expression).
A quota of 5 means that no more than 5 jobs of one kind will be run in
parallel.
Different quotas can be defined for each step: because <code class="docutils literal"><span class="pre">cutadapt</span></code> is
highly I/O-efficient, it has a higher quota.</p>
</div>
<div class="section" id="post-mortem-pipeline-analysis">
<h1>Post-mortem pipeline analysis<a class="headerlink" href="#post-mortem-pipeline-analysis" title="Permalink to this headline">¶</a></h1>
<p>Upon successful completion of a task, an extensive YAML-formatted annotation
is placed next to the output files in a file called
<code class="docutils literal"><span class="pre">.[task_id]-annotation.yaml</span></code>.
Also, for every output file, a symbolic link to this file is created:
<code class="docutils literal"><span class="pre">.[output_filename].annotation.yaml</span></code>.</p>
<p>Finally, the annotation is rendered via GraphViz, if available.
Rendering can also be done at a later time using annotations as input.
The annotation can be used to determine at a later time what exactly happened.
Also, annotations may help to identify bottlenecks.</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="first reference internal image-reference" href="_static/cutadapt.png"><img alt="_static/cutadapt.png" src="_static/cutadapt.png" style="height: 500px;" /></a>
<p class="last">Annotation graph of a <code class="docutils literal"><span class="pre">cutadapt</span></code>
run. CPU and RAM usage for individual
processes are shown, file sizes
and line counts are shown for
output files and inter-process
streams.</p>
</td>
<td><a class="first reference internal image-reference" href="_static/cpu-starving.png"><img alt="_static/cpu-starving.png" src="_static/cpu-starving.png" style="height: 500px;" /></a>
<p class="last">In this graph, it becomes evident that
the <code class="docutils literal"><span class="pre">fix_cutadapt.py</span></code> process in the middle
gets throttled by the following two <code class="docutils literal"><span class="pre">pigz</span></code>
processes, which only run with one core
each and therefore cannot compress the
results fast enough.</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="extending-rnaseq-pipeline">
<h1>Extending rnaseq-pipeline<a class="headerlink" href="#extending-rnaseq-pipeline" title="Permalink to this headline">¶</a></h1>
<p>The provided pipeline can be easily extended by implementing new steps and
sources. Therefore one does need some basic python programming skills. To add a
new processing step, a single Python file must be placed in <code class="docutils literal"><span class="pre">include/step</span></code>
which defines a class with a constructor and two functions. The constructor
(<code class="docutils literal"><span class="pre">__init__</span></code>) checks for the availability of required tools and tells the
pipeline which connections this step expects (<code class="docutils literal"><span class="pre">in/</span></code>) and which it provides
(<code class="docutils literal"><span class="pre">out/</span></code>). The first of the functions  (<code class="docutils literal"><span class="pre">setup_runs</span></code>) is used for planning all
jobs based on a list of input files or runs and possibly additional information
from previous steps and the second function (<code class="docutils literal"><span class="pre">execute</span></code>) is used to execute a
specific job. The basic scaffold is shown below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">abstract_step</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pipeline</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">process_pool</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">class</span> <span class="nc">Macs14</span><span class="p">(</span><span class="n">AbstractStep</span><span class="p">):</span>

    <span class="c"># the constructor</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Macs14</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="c"># define in and out connections the strings have to start with &#39;in/&#39;</span>
        <span class="c"># or &#39;out/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_connection</span><span class="p">(</span><span class="s">&#39;in/something&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_connection</span><span class="p">(</span><span class="s">&#39;out/tag1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_connection</span><span class="p">(</span><span class="s">&#39;out/tag2&#39;</span><span class="p">)</span>
        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">require_tool</span><span class="p">(</span><span class="s">&#39;cat4m&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_tool</span><span class="p">(</span><span class="s">&#39;pigz&#39;</span><span class="p">)</span>
        <span class="o">...</span>

    <span class="c"># all checks of options and input values should be done here</span>
    <span class="k">def</span> <span class="nf">setup_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complete_input_run_info</span><span class="p">,</span> <span class="n">connection_info</span><span class="p">):</span>
        <span class="c"># a hash containing information about this step</span>
        <span class="n">output_run_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># analyze the complete_input_run_info hash provided by the pipeline</span>
        <span class="k">for</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">step_input_info</span> <span class="ow">in</span> <span class="n">complete_input_run_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">input_run_id</span><span class="p">,</span> <span class="n">input_run_info</span> <span class="ow">in</span> <span class="n">step_input_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
               <span class="c"># assemble your output_run_info</span>
               <span class="c"># output_run_info has to look like this</span>
               <span class="n">output_run_info</span><span class="p">:</span>
                   <span class="n">run_id_1</span><span class="p">:</span>
                       <span class="s">&quot;output_files&quot;</span><span class="p">:</span>
                           <span class="n">tag1</span><span class="p">:</span>
                               <span class="n">output_file_1</span><span class="p">:</span> <span class="p">[</span><span class="n">input_file_1</span><span class="p">,</span> <span class="n">input_file_2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                               <span class="n">output_file_2</span><span class="p">:</span> <span class="p">[</span><span class="n">input_file_1</span><span class="p">,</span> <span class="n">input_file_2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                           <span class="n">tag2</span><span class="p">:</span>
                               <span class="n">output_file_3</span><span class="p">:</span> <span class="p">[</span><span class="n">input_file_1</span><span class="p">,</span> <span class="n">input_file_2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                               <span class="n">output_file_4</span><span class="p">:</span> <span class="p">[</span><span class="n">input_file_1</span><span class="p">,</span> <span class="n">input_file_2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                       <span class="s">&quot;info&quot;</span><span class="p">:</span>
                           <span class="o">...</span>
                       <span class="n">more</span><span class="p">:</span>
                           <span class="o">...</span>
                       <span class="n">keys</span><span class="p">:</span>
                           <span class="o">...</span>
                   <span class="n">run_id_2</span><span class="p">:</span>
                       <span class="o">...</span>

        <span class="k">return</span> <span class="n">output_run_info</span>

    <span class="c"># called to actually launch the job (run_info is the hash returned from</span>
    <span class="c"># setup_runs)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">run_info</span><span class="p">):</span>

        <span class="k">with</span> <span class="n">process_pool</span><span class="o">.</span><span class="n">ProcessPool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pool</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">pipeline</span><span class="p">:</span>
                <span class="c"># assemble the steps pipline here</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
                <span class="o">...</span>
                <span class="c"># finally launch it</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The code shown above is the framework for a new step. The most essential part is
the hash returned by setup_runs(), here called <code class="docutils literal"><span class="pre">output_run_info</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">run_id</span></code>:</th><td class="field-body">It has to be the unique name of a run (obviously, because its a key value).
<code class="docutils literal"><span class="pre">output_run_info</span></code> can contain multiple <code class="docutils literal"><span class="pre">run_id</span></code> hashes.</td>
</tr>
<tr class="field-even field"><th class="field-name"><code class="docutils literal"><span class="pre">&quot;output_files&quot;</span></code>:</th><td class="field-body">This is the only hash key that has to have a fix name. This is used to link
input to output files.</td>
</tr>
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">tag[12]</span></code>:</th><td class="field-body">Every <code class="docutils literal"><span class="pre">tag</span></code> has to match <code class="docutils literal"><span class="pre">\w+$</span></code> in the string <code class="docutils literal"><span class="pre">'out/tag'</span></code>, which was
given to <code class="docutils literal"><span class="pre">self.add_connection('out/tag')</span></code>. This can be any string, but it
has to match with the last part of the connection string.</td>
</tr>
<tr class="field-even field"><th class="field-name"><code class="docutils literal"><span class="pre">output_file_\d</span></code>:</th><td class="field-body">Each <code class="docutils literal"><span class="pre">tag</span></code> has to contain at least one such key. It has to be the name of
the output file produced by the connection <code class="docutils literal"><span class="pre">'out/tag'</span></code>. The value of this
has to be a list of related input files. The list can have any number of
entries even zero. Multiple <code class="docutils literal"><span class="pre">output_file_\d</span></code> can rely on the same set of
input files.</td>
</tr>
</tbody>
</table>
<p>Also very important is to understand the concept of <em>connections</em>. They provide
input files prior steps created already. The names of the connections can be
arbitrarily chosen, but should <strong>not</strong> describe the file format but more general
terms. For example an <code class="docutils literal"><span class="pre">out/alignment</span></code> can provide gzipped SAM or BAM files. So
you have to check in setup runs for the file type provided by a connection and
react accordingly. Inspect <code class="docutils literal"><span class="pre">complete_input_run_info</span></code> to find out what your
step gets as input.</p>
<div class="section" id="best-practices">
<h2>Best practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of things which should be kept in mind when implementing new
steps or modifying existing steps:</p>
<ul class="simple">
<li>Make sure errors already show up in <code class="docutils literal"><span class="pre">setup_runs</span></code> instead of <code class="docutils literal"><span class="pre">execute</span></code>.
Therefore look out for things that may fail in <code class="docutils literal"><span class="pre">setup_runs</span></code>. Stick to <em>fail
early, fail often</em>. That way errors show up before submitting jobs to the
cluster and wasting precious cluster waiting time is avoided.</li>
<li>Use the <code class="docutils literal"><span class="pre">info</span></code> entry in the returned <code class="docutils literal"><span class="pre">output_run_info</span></code> structure to pass
information gathered in <code class="docutils literal"><span class="pre">setup_runs</span></code> to <code class="docutils literal"><span class="pre">execute</span></code>.</li>
<li>Likewise, make sure that the tools you&#8217;ll need in <code class="docutils literal"><span class="pre">execute</span></code> are available.
Check for the availability of tools within the constructor <code class="docutils literal"><span class="pre">__init__</span></code>.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># make sure tools are available</span>
<span class="bp">self</span><span class="o">.</span><span class="n">require_tool</span><span class="p">(</span><span class="s">&#39;pigz&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">require_tool</span><span class="p">(</span><span class="s">&#39;cutadapt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Make sure your disk access is as cluster-friendly as possible (which
primarily means using large block sizes and preferably no seek operations).
If possible, use <code class="docutils literal"><span class="pre">unix_pipeline</span></code> to wrap your commands in <code class="docutils literal"><span class="pre">pigz</span></code>, <code class="docutils literal"><span class="pre">dd</span></code>,
or <code class="docutils literal"><span class="pre">cat4m</span></code> with a large block size like 4 MB.
Although this is not possible in every case (for example when seeking
in files is involved), it is straightforward with tools that read a
continuous stream from <code class="docutils literal"><span class="pre">stdin</span></code> and write a continuous stream to
<code class="docutils literal"><span class="pre">stdout</span></code>.</li>
</ul>
<p>To insert a new step in a pipeline it has to be added into the <code class="docutils literal"><span class="pre">config.yaml</span></code>.</p>
</div>
</div>
<div class="section" id="to-do-list">
<h1>To-do list<a class="headerlink" href="#to-do-list" title="Permalink to this headline">¶</a></h1>
<dl class="docutils">
<dt>Timestamps:</dt>
<dd><code class="docutils literal"><span class="pre">unix_pipeline</span></code> log messages should include timestamps.</dd>
<dt>Getting started package:</dt>
<dd>We need a small package which demonstrates a quick pipeline, including
the configuration and all required tools.</dd>
<dt>Steps should be able to access all ancestors:</dt>
<dd>All upstream steps should be accessible via their step name or output
file key.</dd>
<dt>On-the-fly steps:</dt>
<dd><p class="first">We need a way to skip writing certain output files and have them flow
temporarily through a pipe only, if possible.
This is a disk space-saving feature only and has no effect on the
outcome of the pipeline. However, it would require that a step is
capable of being run <em>on-the-fly</em> which means it must read and write in
a single stream.</p>
<p class="last">Here&#8217;s an example:</p>
</dd>
<dt>Miscellaneous input files:</dt>
<dd>Genome files and their index such as used by segemehl should not be defined
via a fixed path.
For traceability, it would be preferable to specify the hg19.fa URL and
checksum and have the index generated by a step which the segemehl step
depends on.</dd>
</dl>
<p>Make <code class="docutils literal"><span class="pre">run-locally.py</span></code> exit gracefully on receiving SIGTERM.</p>
<dl class="docutils">
<dt>Show statistics for executing tasks:</dt>
<dd>When showing currently executing tasks, show how long this job has already been
running and how it relates to jobs that have already finished.</dd>
</dl>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="documentation.html" class="btn btn-neutral float-right" title="Configuration of uap">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral" title="Installation"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Christoph Kämpf, Michael Specht.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>